@page "/auth/signin"
@using DevQualX.Application.Authentication
@using DevQualX.Functional
@inject IInitiateOAuth InitiateOAuth
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Navigation

<PageTitle>Sign In - DevQualX</PageTitle>

<div class="sign-in-container">
    <div class="sign-in-card">
        <h1>Welcome to DevQualX</h1>
        <p class="subtitle">Code Quality Analysis for .NET Projects</p>
        
        @if (errorMessage != null)
        {
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
        }
        
        <div class="sign-in-actions">
            <button class="btn btn-primary btn-lg" @onclick="SignInWithGitHub" disabled="@isProcessing">
                @if (isProcessing)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                }
                <svg class="github-icon" height="20" width="20" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
                Sign in with GitHub
            </button>
        </div>
        
        <p class="privacy-note">
            By signing in, you agree to our Terms of Service and Privacy Policy.
        </p>
    </div>
</div>

@code {
    private bool isProcessing = false;
    private string? errorMessage = null;
    
    private async Task SignInWithGitHub()
    {
        if (isProcessing) return;
        
        isProcessing = true;
        errorMessage = null;
        
        try
        {
            // Build callback URI
            var redirectUri = Navigation.ToAbsoluteUri("/auth/callback").ToString();
            
            // Initiate OAuth flow
            var result = await InitiateOAuth.ExecuteAsync(redirectUri);
            
            if (result is Failure<OAuthInitiationResult, Error> failure)
            {
                errorMessage = $"Failed to initiate sign-in: {failure.Error.Message}";
                isProcessing = false;
                return;
            }
            
            var initiation = ((Success<OAuthInitiationResult, Error>)result).Value;
            
            // Store PKCE code verifier and state in session
            var session = HttpContextAccessor.HttpContext?.Session;
            if (session == null)
            {
                errorMessage = "Session is not available. Please enable cookies.";
                isProcessing = false;
                return;
            }
            
            session.SetString("OAuth_CodeVerifier", initiation.CodeVerifier);
            session.SetString("OAuth_State", initiation.State);
            
            // Redirect to GitHub authorization URL
            Navigation.NavigateTo(initiation.AuthorizationUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            errorMessage = $"An unexpected error occurred: {ex.Message}";
            isProcessing = false;
        }
    }
}

<style>
    .sign-in-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 80vh;
        padding: 2rem;
    }
    
    .sign-in-card {
        max-width: 480px;
        width: 100%;
        padding: 3rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
    }
    
    .sign-in-card h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: #1a1a1a;
    }
    
    .subtitle {
        font-size: 1rem;
        color: #666;
        margin-bottom: 2rem;
    }
    
    .sign-in-actions {
        margin: 2rem 0;
    }
    
    .btn-primary {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 2rem;
        font-size: 1.125rem;
        border-radius: 8px;
    }
    
    .github-icon {
        margin-right: 0.5rem;
    }
    
    .privacy-note {
        font-size: 0.875rem;
        color: #999;
        margin-top: 2rem;
    }
    
    .alert {
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 8px;
        text-align: left;
    }
    
    .alert-danger {
        background-color: #fee;
        border: 1px solid #fcc;
        color: #c33;
    }
</style>
