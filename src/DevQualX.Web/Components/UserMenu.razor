@using DevQualX.Web.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject OrgContextService OrgContext
@inject NavigationManager Navigation

<AuthorizeView>
    <Authorized>
        <div class="user-menu">
            <button class="user-menu-button" @onclick="ToggleDropdown">
                @if (!string.IsNullOrEmpty(avatarUrl))
                {
                    <img src="@avatarUrl" alt="@username" class="user-avatar" />
                }
                else
                {
                    <div class="user-avatar-placeholder">
                        @GetInitials(username)
                    </div>
                }
                <span class="user-name">@username</span>
                <svg class="chevron-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 5.293a1 1 0 011.414 0L8 7.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
            
            @if (isDropdownOpen)
            {
                <div class="user-menu-dropdown">
                    <div class="user-menu-header">
                        <div class="user-info">
                            <div class="user-info-name">@username</div>
                            @if (!string.IsNullOrEmpty(email))
                            {
                                <div class="user-info-email">@email</div>
                            }
                        </div>
                    </div>
                    
                    <div class="user-menu-divider"></div>
                    
                    <div class="user-menu-items">
                        <a href="/profile" class="user-menu-item">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 8a3 3 0 100-6 3 3 0 000 6zm2 2a4 4 0 00-4 0c-1.5.5-2 1.5-2 2.5V14h8v-1.5c0-1-.5-2-2-2.5z"/>
                            </svg>
                            Profile
                        </a>
                        
                        <a href="/settings" class="user-menu-item">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.429 1.525a6.593 6.593 0 011.142 0c.036.003.108.036.137.146l.289 1.105c.147.56.55.967.997 1.189.174.086.341.183.501.29.417.278.97.423 1.53.27l1.102-.303c.11-.03.175.016.195.046.219.31.41.641.573.989.014.031.022.11-.059.19l-.815.806c-.411.406-.562.957-.53 1.456a4.588 4.588 0 010 .582c-.032.499.119 1.05.53 1.456l.815.806c.08.08.073.159.059.19a6.494 6.494 0 01-.573.99c-.02.029-.086.074-.195.045l-1.103-.303c-.559-.153-1.112-.008-1.529.27-.16.107-.327.204-.5.29-.449.222-.851.628-.998 1.189l-.289 1.105c-.029.11-.101.143-.137.146a6.613 6.613 0 01-1.142 0c-.036-.003-.108-.037-.137-.146l-.289-1.105c-.147-.56-.55-.967-.997-1.189a4.502 4.502 0 01-.501-.29c-.417-.278-.97-.423-1.53-.27l-1.102.303c-.11.03-.175-.016-.195-.046a6.492 6.492 0 01-.573-.989c-.014-.031-.022-.11.059-.19l.815-.806c.411-.406.562-.957.53-1.456a4.587 4.587 0 010-.582c.032-.499-.119-1.05-.53-1.456l-.815-.806c-.08-.08-.073-.159-.059-.19a6.44 6.44 0 01.573-.99c.02-.029.086-.075.195-.045l1.103.303c.559.153 1.112.008 1.529-.27.16-.107.327-.204.5-.29.449-.222.851-.628.998-1.189l.289-1.105c.029-.11.101-.143.137-.146zM8 10a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                            </svg>
                            Settings
                        </a>
                    </div>
                    
                    <div class="user-menu-divider"></div>
                    
                    <div class="user-menu-items">
                        <a href="/auth/signout" class="user-menu-item">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 3.5A1.5 1.5 0 014.5 2h6A1.5 1.5 0 0112 3.5v3a.5.5 0 01-1 0v-3a.5.5 0 00-.5-.5h-6a.5.5 0 00-.5.5v9a.5.5 0 00.5.5h6a.5.5 0 00.5-.5v-3a.5.5 0 011 0v3A1.5 1.5 0 0110.5 14h-6A1.5 1.5 0 013 12.5v-9zm9.854 2.646a.5.5 0 010 .708L10.707 9H6.5a.5.5 0 010-1h4.207L8.854 6.146a.5.5 0 11.708-.708l3 3z" clip-rule="evenodd"/>
                            </svg>
                            Sign out
                        </a>
                    </div>
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <a href="/auth/signin" class="btn btn-primary">Sign in</a>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool isDropdownOpen = false;
    private string? username;
    private string? email;
    private string? avatarUrl;
    
    protected override void OnInitialized()
    {
        username = OrgContext.GetCurrentUsername() ?? "User";
        email = OrgContext.GetCurrentUserEmail();
        avatarUrl = OrgContext.GetCurrentUserAvatarUrl();
    }
    
    private void ToggleDropdown()
    {
        isDropdownOpen = !isDropdownOpen;
    }
    
    private string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return "U";
        }
        
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpperInvariant();
        }
        
        return name[0].ToString().ToUpperInvariant();
    }
}

<style>
    .user-menu {
        position: relative;
    }
    
    .user-menu-button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: transparent;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .user-menu-button:hover {
        background: #f9fafb;
    }
    
    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .user-avatar-placeholder {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #6366f1;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .user-name {
        font-size: 0.875rem;
        font-weight: 500;
        color: #1f2937;
    }
    
    .chevron-icon {
        color: #6b7280;
    }
    
    .user-menu-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.5rem;
        width: 240px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 50;
    }
    
    .user-menu-header {
        padding: 0.75rem 1rem;
    }
    
    .user-info-name {
        font-size: 0.875rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    .user-info-email {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.125rem;
    }
    
    .user-menu-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 0.5rem 0;
    }
    
    .user-menu-items {
        padding: 0.5rem;
    }
    
    .user-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.625rem 0.75rem;
        font-size: 0.875rem;
        color: #374151;
        text-decoration: none;
        border-radius: 6px;
        transition: background-color 0.2s;
    }
    
    .user-menu-item:hover {
        background: #f3f4f6;
    }
    
    .user-menu-item svg {
        color: #6b7280;
    }
    
    .btn-primary {
        padding: 0.5rem 1rem;
        background: #6366f1;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .btn-primary:hover {
        background: #4f46e5;
    }
</style>
